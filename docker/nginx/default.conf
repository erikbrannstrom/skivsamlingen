server {
    listen 80;
    server_name localhost;
    root /var/www/skivsamlingen.se;
    index index.php;

    # Static assets
    location /static/ {
        expires 30d;
    }

    # Laravel routes (uncomment as controllers are migrated)
    location /news {
        try_files $uri $uri/ @laravel;
    }
    location = / {
        try_files $uri @laravel;
    }
    location /about {
        try_files $uri $uri/ @laravel;
    }
    # location /users {
    #     try_files $uri $uri/ @laravel;
    # }
    # location /account {
    #     try_files $uri $uri/ @laravel;
    # }
    # location /collection {
    #     try_files $uri $uri/ @laravel;
    # }

    # Test route for SharedAuth middleware verification
    location /auth-test {
        try_files $uri $uri/ @laravel;
    }

    # Laravel handler - PHP 8.3
    location @laravel {
        rewrite ^(.*)$ /laravel/public/index.php?$query_string last;
    }

    # Laravel PHP processing (PHP 8.3)
    location ~ ^/laravel/public/index\.php$ {
        fastcgi_pass php83:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/skivsamlingen.se/laravel/public/index.php;
        fastcgi_param HTTP_COOKIE $http_cookie;
        include fastcgi_params;
    }

    # Default: CodeIgniter handles everything
    location / {
        try_files $uri $uri/ /index.php?$uri&$args;
    }

    # CodeIgniter PHP processing (PHP 5.6)
    # Uses index.docker.php which sets ENVIRONMENT='testing' to suppress notices
    location ~ \.php$ {
        fastcgi_pass php56:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/skivsamlingen.se/index.docker.php;
        include fastcgi_params;
    }
}
